==================
Force Calculation
==================
Consider a material containing :math:`N` atoms has a total potential energy
:math:`\cal E`. The atomistic environment of each atom can be described by :math:`M` fingerprints :math:`G_{im}` (:math:`i=1,2,\dots,N` and :math:`m=1,2,\dots,M`), which are used to determine the potential energy :math:`E_{i}` of :math:`i`-th atom. The atomic forces acting on each atom can be calculated as: 


.. math::
   f_{j\alpha}=-\frac{\partial {\cal E}}{\partial r_{j\alpha}}= -
   \sum_{i=1}^{N} \frac{\partial E_i (G_{i1},
   G_{i2},\dots,G_{iM})}{\partial r_{j\alpha}} = -  \sum_{i=1}^{N}
   \sum_{m=1}^{M}	{\frac{\partial E_i}{\partial G_{im}}}
   {\frac{\partial G_{im}}{\partial r_{j\alpha}}}

where :math:`r_{j\alpha}` (:math:`\alpha=1,2,3`) are the Cartesian coordinates of :math:`j`-th atom (:math:`j=1,2,\dots,N`). 


In Tensorflow, it is more convenient and efficient to implement the above summation
in terms of matrix multiplication. Therefore, we define matrix

.. math::
   [dEdG]_i = 	\begin{pmatrix} \dfrac{\partial E_i}{\partial G_{i1}}
   & \dfrac{\partial E_i}{\partial G_{i2}}	& \dots &
   \dfrac{\partial E_i}{\partial G_{iM}} \end{pmatrix}


and

.. math::
    [dGdr]_{ij} = \begin{bmatrix}
		\dfrac{\partial G_{i1}}{\partial r_{j1}} & \dfrac{\partial G_{i1}}{\partial r_{j2}} & \dfrac{\partial G_{i1}}{\partial r_{j3}}  \\ \rule{0pt}{22pt}
		\dfrac{\partial G_{i2}}{\partial r_{j1}} & \dfrac{\partial G_{i2}}{\partial r_{j2}} & \dfrac{\partial G_{i2}}{\partial r_{j3}}  \\ \rule{0pt}{15pt}
		\vdots & \vdots & \vdots \\\rule{0pt}{15pt}
		\dfrac{\partial G_{iM}}{\partial r_{j1}} & \dfrac{\partial G_{iM}}{\partial r_{j2}} & \dfrac{\partial G_{iM}}{\partial r_{j3}}  \\ 
	\end{bmatrix}


Next, we use an example to demonstrate the matrix multiplicaiton
process. Assume there are 8 pairs of derivative (:math:`dGdr`) data in
one structure that contains 6 atoms. The center atoms IDs for thes 8 pairs are

.. math::
    \begin{bmatrix}
        1&2&2&4&5&0&1&2
    \end{bmatrix}

The neighbor atoms IDs are

.. math::
   \begin{equation}
   \begin{bmatrix}
   2&3&4&2&1&4&0&4
   \end{bmatrix}
   \end{equation}

The atomic forces can be computed as:

.. math::
   \begin{equation}
   \begin{bmatrix}
		\left[dEdG\right]_1 \\ \rule{0pt}{10pt}
		\left[dEdG\right]_2  \\ \rule{0pt}{10pt}
		\left[dEdG\right]_2  \\ \rule{0pt}{10pt}
		\left[dEdG\right]_4  \\ \rule{0pt}{10pt}
		\left[dEdG\right]_5  \\ \rule{0pt}{10pt}
		\left[dEdG\right]_0  \\ \rule{0pt}{10pt}
		\left[dEdG\right]_1  \\ \rule{0pt}{10pt}
		\left[dEdG\right]_2  \\ 
	\end{bmatrix}
 	\begin{bmatrix}
 		\left[dGdr\right]_{12} \\ \rule{0pt}{10pt}
 		\left[dGdr\right]_{23} \\ \rule{0pt}{10pt}
 		\left[dGdr\right]_{24} \\ \rule{0pt}{10pt}
 		\left[dGdr\right]_{42} \\ \rule{0pt}{10pt}
 		\left[dGdr\right]_{51} \\ \rule{0pt}{10pt}
 		\left[dGdr\right]_{04} \\ \rule{0pt}{10pt}
 		\left[dGdr\right]_{10} \\ \rule{0pt}{10pt}
 		\left[dGdr\right]_{24} \\ 
 	\end{bmatrix}
 	= 	\begin{bmatrix}
 			(f_2^x)_1 & (f_2^y)_1 & (f_2^z)_1 \\ \rule{0pt}{10pt}
 			(f_3^x)_2 & (f_3^y)_2 & (f_3^z)_2 \\ \rule{0pt}{10pt}
 			(f_4^x)_2 & (f_4^y)_2 & (f_4^z)_2 \\ \rule{0pt}{10pt}
 			(f_2^x)_4 & (f_2^y)_4 & (f_2^z)_4 \\ \rule{0pt}{10pt}
 			(f_1^x)_5 & (f_1^y)_5 & (f_1^z)_5 \\ \rule{0pt}{10pt}
 			(f_4^x)_0 & (f_4^y)_0 & (f_4^z)_0 \\ \rule{0pt}{10pt}
 			(f_0^x)_1 & (f_0^y)_1 & (f_0^z)_1 \\ \rule{0pt}{10pt}
 			(f_4^x)_2 & (f_4^y)_2 & (f_4^z)_2 
 	\end{bmatrix}
	\end{equation}

where :math:`(f_j^x)_i` is the force on :math:`j`-th atom contributed
by atom :math:`i`. Then we need to compute the total force acting on
atom :math:`j`, :math:`F_j`, by summing up all the contributions for
other atoms. This is done by using one-hot matrix generated by the
neighbor atom IDs:

.. math::
   \begin{equation}
	-\begin{bmatrix}
		0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 \\ \rule{0pt}{10pt}
		0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 \\ \rule{0pt}{10pt}
		1 & 0 & 0 & 1 & 0 & 0 & 0 & 0 \\ \rule{0pt}{10pt}
		0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\ \rule{0pt}{10pt}
		0 & 0 & 1 & 0 & 0 & 1 & 0 & 1 \\ \rule{0pt}{10pt}
		0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 
	\end{bmatrix}
    \begin{bmatrix}
 			(f_2^x)_1 & (f_2^y)_1 & (f_2^z)_1 \\ \rule{0pt}{10pt}
 			(f_3^x)_2 & (f_3^y)_2 & (f_3^z)_2 \\ \rule{0pt}{10pt}
 			(f_4^x)_2 & (f_4^y)_2 & (f_4^z)_2 \\ \rule{0pt}{10pt}
 			(f_2^x)_4 & (f_2^y)_4 & (f_2^z)_4 \\ \rule{0pt}{10pt}
 			(f_1^x)_5 & (f_1^y)_5 & (f_1^z)_5 \\ \rule{0pt}{10pt}
 			(f_4^x)_0 & (f_4^y)_0 & (f_4^z)_0 \\ \rule{0pt}{10pt}
 			(f_0^x)_1 & (f_0^y)_1 & (f_0^z)_1 \\ \rule{0pt}{10pt}
 			(f_4^x)_2 & (f_4^y)_2 & (f_4^z)_2 
 	\end{bmatrix}
	=	\begin{bmatrix}
		F_0^x & F_0^y & F_0^z \\ \rule{0pt}{10pt}
		F_1^x & F_1^y & F_1^z \\ \rule{0pt}{10pt}
		F_2^x & F_2^y & F_2^z \\ \rule{0pt}{10pt}
		F_3^x & F_3^y & F_3^z \\ \rule{0pt}{10pt}
		F_4^x & F_4^y & F_4^z \\ \rule{0pt}{10pt}
		F_5^x & F_5^y & F_5^z 
	\end{bmatrix}
	\end{equation}
	
