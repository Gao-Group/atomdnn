<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example &mdash; AtomDNN  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> AtomDNN
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorials/data_pipeline.html">Data pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/energy_calculation.html">Energy calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/force_calculation.html">Force and stress calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/lammps.html">LAMMPS interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="module/descriptor.html">Descriptor</a></li>
<li class="toctree-l1"><a class="reference internal" href="module/data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="module/network.html">Network</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="about/authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="about/contact.html">Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="about/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="about/funding.html">Funding</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">AtomDNN</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Example</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/example.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Example">
<h1>Example<a class="headerlink" href="#Example" title="Permalink to this heading"></a></h1>
<p>This example demonstrates the whole process from initial atomic structure to training, evaluation and prediction. It includes:</p>
<ol class="arabic simple">
<li><p>Read input atomic structures (saved as extxyz files) and create descriptors and their derivatives.</p></li>
<li><p>Read inputs and outputs into a Data object.</p></li>
<li><p>Create tensorflow dataset for training.</p></li>
<li><p>Train the potential and apply it for prediction.</p></li>
<li><p>Save the trained model and then load it for retraining or prediction.</p></li>
</ol>
<p>The code has been tested on Tensorflow 2.5 and 2.6.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">atomdnn</span>

<span class="c1"># &#39;float64&#39; is used for reading data and train by default</span>
<span class="n">atomdnn</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span>

<span class="c1"># force and stress are evaluated by default,</span>
<span class="c1"># if one only need to compute potential energy, then set compute_force to false</span>
<span class="n">atomdnn</span><span class="o">.</span><span class="n">compute_force</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># default value is for converting ev/A^3 to GPa</span>
<span class="c1"># note that: the predicted positive stress means tension and negative stress means compression</span>
<span class="n">stress_unit_convert</span> <span class="o">=</span> <span class="mf">160.2176</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">atomdnn</span> <span class="kn">import</span> <span class="n">data</span>
<span class="kn">from</span> <span class="nn">atomdnn.data</span> <span class="kn">import</span> <span class="n">Data</span>
<span class="kn">from</span> <span class="nn">atomdnn.data</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">atomdnn.io</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">atomdnn</span> <span class="kn">import</span> <span class="n">network</span>
<span class="kn">from</span> <span class="nn">atomdnn.network</span> <span class="kn">import</span> <span class="n">Network</span>
</pre></div>
</div>
</div>
<section id="Create-descriptors">
<h2>Create descriptors<a class="headerlink" href="#Create-descriptors" title="Permalink to this heading"></a></h2>
<p><strong>Read input atomic structures (saved as extxyz files) and create descriptors and their derivatives</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">descriptor</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;acsf&#39;</span><span class="p">,</span>
              <span class="s1">&#39;cutoff&#39;</span><span class="p">:</span> <span class="mf">6.5</span><span class="p">,</span>
              <span class="s1">&#39;etaG2&#39;</span><span class="p">:[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span>
              <span class="s1">&#39;etaG4&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">],</span>
              <span class="s1">&#39;zeta&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.08</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">50.0</span><span class="p">,</span><span class="mf">100.0</span><span class="p">],</span>
              <span class="s1">&#39;lambda&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]}</span>

<span class="c1"># define lammps excutable (serial or mpi)</span>
<span class="c1"># LAMMPS has to be compiled with the added compute and dump_local subrutines (inside atomdnn/lammps)</span>
<span class="n">lmpexe</span> <span class="o">=</span> <span class="s1">&#39;lmp_serial&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xyzfile_path</span> <span class="o">=</span> <span class="s1">&#39;./extxyz&#39;</span>
<span class="n">xyzfile_name</span> <span class="o">=</span> <span class="s1">&#39;example_extxyz.*&#39;</span> <span class="c1"># a serials of files like example_extxyz.1, example_extxyz.2, ...example_extxyz.n</span>
<span class="n">descriptors_path</span> <span class="o">=</span> <span class="s1">&#39;./descriptors&#39;</span>
<span class="n">descriptor_filename</span> <span class="o">=</span> <span class="s1">&#39;dump_fp&#39;</span> <span class="c1"># a serials of dump_fp.* files will be created</span>
<span class="n">der_filename</span> <span class="o">=</span><span class="s1">&#39;dump_der&#39;</span>

<span class="c1"># this will create a serials of files for descriptors and their derivatives inside descriptors_path</span>
<span class="c1"># by default, descriptor files are saved as &#39;dump_fp.*&#39; and derivatives are saved as &#39;dump_der.*&#39;</span>
<span class="n">create_descriptors</span><span class="p">(</span><span class="n">xyzfile_path</span> <span class="o">=</span> <span class="n">xyzfile_path</span><span class="p">,</span> \
                   <span class="n">xyzfile_name</span> <span class="o">=</span> <span class="n">xyzfile_name</span><span class="p">,</span> \
                   <span class="n">lmpexe</span> <span class="o">=</span> <span class="n">lmpexe</span><span class="p">,</span> \
                   <span class="n">descriptors_path</span> <span class="o">=</span> <span class="n">descriptors_path</span><span class="p">,</span> \
                   <span class="n">descriptor</span> <span class="o">=</span> <span class="n">descriptor</span><span class="p">,</span> \
                   <span class="n">descriptor_filename</span> <span class="o">=</span> <span class="n">descriptor_filename</span><span class="p">,</span> \
                   <span class="n">der_filename</span> <span class="o">=</span> <span class="n">der_filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Start creating fingerprints ...
  so far finished for 10 images ...
  so far finished for 20 images ...
  so far finished for 30 images ...
  so far finished for 40 images ...
  so far finished for 50 images ...
Finish creating descriptors and their derivatives from total 50 images.
It took 5.02 seconds.
</pre></div></div>
</div>
</section>
<section id="Read-inputs&amp;outputs">
<h2>Read inputs&amp;outputs<a class="headerlink" href="#Read-inputs&outputs" title="Permalink to this heading"></a></h2>
<p><strong>Read inputs and outputs into a Data object</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a Data object</span>
<span class="n">grdata</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>

<span class="c1"># read inputs: descriptors and their derivatives</span>
<span class="n">fp_filename</span> <span class="o">=</span> <span class="n">descriptors_path</span> <span class="o">+</span> <span class="s1">&#39;/dump_fp.*&#39;</span>
<span class="n">der_filename</span> <span class="o">=</span> <span class="n">descriptors_path</span> <span class="o">+</span> <span class="s1">&#39;/dump_der.*&#39;</span>

<span class="n">grdata</span><span class="o">.</span><span class="n">read_inputdata</span><span class="p">(</span><span class="n">fp_filename</span> <span class="o">=</span> <span class="n">fp_filename</span><span class="p">,</span><span class="n">der_filename</span> <span class="o">=</span> <span class="n">der_filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Reading fingerprints data from LAMMPS dump files ./descriptors/dump_fp.i
  so far read 50 images ...
  Finish reading fingerprints from total 50 images.

  image number = 50
  max number of atom = 4
  number of fingerprints = 22
  type of atoms = 1

Reading derivative data from a series of files ./descriptors/dump_der.i
This may take a while for large data set ...
  so far read 50 images ...
  Finish reading dGdr derivatives from total 50 images.

  Pad zeros to derivatives data if needed ...
  Pading finished: 48 images derivatives have been padded with zeros.

  image number = 50
  max number of derivative pairs = 200
  number of fingerprints = 22

  It took 0.90 seconds to read the derivatives data.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read outputs: potential energy, force and stress from extxyz files</span>
<span class="n">grdata</span><span class="o">.</span><span class="n">read_outputdata</span><span class="p">(</span><span class="n">xyzfile_path</span><span class="o">=</span><span class="n">xyzfile_path</span><span class="p">,</span> <span class="n">xyzfile_name</span><span class="o">=</span><span class="n">xyzfile_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Reading outputs from extxyz files ...
  so far read 50 images ...
  Finish reading outputs from total 50 images.

</pre></div></div>
</div>
</section>
<section id="Create-TFdataset">
<h2>Create TFdataset<a class="headerlink" href="#Create-TFdataset" title="Permalink to this heading"></a></h2>
<p><strong>Create tensorflow dataset for training</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert data to tensors</span>
<span class="n">grdata</span><span class="o">.</span><span class="n">convert_data_to_tensor</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Conversion may take a while for large datasets...
It took 0.2547 second.
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create tensorflow dataset</span>
<span class="n">tf_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">grdata</span><span class="o">.</span><span class="n">input_dict</span><span class="p">,</span><span class="n">grdata</span><span class="o">.</span><span class="n">output_dict</span><span class="p">))</span>

<span class="n">dataset_path</span> <span class="o">=</span> <span class="s1">&#39;./example_tfdataset&#39;</span>

<span class="c1"># save the dataset</span>
<span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tf_dataset</span><span class="p">,</span> <span class="n">dataset_path</span><span class="p">)</span>

<span class="c1"># save the element_spec to disk for future loading, this is only needed for tensorflow lower than 2.6</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataset_path</span> <span class="o">+</span> <span class="s1">&#39;/element_spec&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">tf_dataset</span><span class="o">.</span><span class="n">element_spec</span><span class="p">,</span> <span class="n">out_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><strong>Note: The above three steps just need to be done once for one data set, the training only uses the saved tensorflow dataset.</strong></p>
</section>
<section id="Training">
<h2>Training<a class="headerlink" href="#Training" title="Permalink to this heading"></a></h2>
<p><strong>Load the dataset and train the model</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load tensorflow dataset, for Tensorflow version lower than 2.6, need to specify element_spec.</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataset_path</span> <span class="o">+</span> <span class="s1">&#39;/element_spec&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_</span><span class="p">:</span>
    <span class="n">element_spec</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_</span><span class="p">)</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span><span class="n">element_spec</span><span class="o">=</span><span class="n">element_spec</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># split the data to training, validation and testing sets</span>

<span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">split_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Traning data: 35 images
Validation data: 10 images
Test data: 5 images
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build the network</span>
<span class="c1"># See section &#39;Training&#39; for detailed description on Network object.</span>

<span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span>
<span class="n">act_fun</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span> <span class="c1"># activation function</span>
<span class="n">nfp</span> <span class="o">=</span> <span class="n">get_fingerprints_num</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="c1"># number of fingerprints (or descriptors)</span>
<span class="n">arch</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span> <span class="c1"># NN layers</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Network</span><span class="p">(</span><span class="n">elements</span> <span class="o">=</span> <span class="n">elements</span><span class="p">,</span>\
                <span class="n">num_fingerprints</span> <span class="o">=</span> <span class="n">nfp</span><span class="p">,</span>\
                <span class="n">arch</span> <span class="o">=</span> <span class="n">arch</span><span class="p">,</span>\
                <span class="n">activation_function</span> <span class="o">=</span> <span class="n">act_fun</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train the model</span>

<span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;Adam&#39;</span> <span class="c1"># optimizer</span>
<span class="n">loss_fun</span> <span class="o">=</span> <span class="s1">&#39;mae&#39;</span> <span class="c1"># loss function</span>
<span class="n">scaling</span> <span class="o">=</span> <span class="s1">&#39;std&#39;</span> <span class="c1"># scaling the traning data with standardization</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">0.02</span> <span class="c1"># learning rate</span>
<span class="n">loss_weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pe&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;force&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;stress&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span> <span class="c1"># the weights in loss function</span>

<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> \
            <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> \
            <span class="n">loss_fun</span> <span class="o">=</span> <span class="n">loss_fun</span><span class="p">,</span> \
            <span class="n">batch_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> \
            <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> \
            <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> \
            <span class="n">scaling</span><span class="o">=</span><span class="n">scaling</span><span class="p">,</span> \
            <span class="n">loss_weights</span><span class="o">=</span><span class="n">loss_weights</span><span class="p">,</span> \
            <span class="n">compute_all_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> \
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> \
            <span class="n">append_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Forces are used for training.
Stresses are used for training.
Scaling factors are computed using training dataset.
Training dataset are standardized.
Validation dataset are standardized.
Training dataset will be shuffled during training.

===&gt; Epoch 1/50 - 0.242s/epoch
     training_loss    - pe_loss: 63.060 - force_loss: 340.074 - stress_loss: 7355.740 - total_loss: 1138.708
     validation_loss  - pe_loss: 47.981 - force_loss: 340.109 - stress_loss: 11641.806 - total_loss: 1552.271

===&gt; Epoch 2/50 - 0.202s/epoch
     training_loss    - pe_loss: 41.839 - force_loss: 338.547 - stress_loss: 6488.671 - total_loss: 1029.253
     validation_loss  - pe_loss: 37.360 - force_loss: 302.898 - stress_loss: 11096.109 - total_loss: 1449.869

===&gt; Epoch 3/50 - 0.229s/epoch
     training_loss    - pe_loss: 30.148 - force_loss: 295.398 - stress_loss: 6031.364 - total_loss: 928.682
     validation_loss  - pe_loss: 27.729 - force_loss: 257.073 - stress_loss: 6611.963 - total_loss: 945.998

===&gt; Epoch 4/50 - 0.221s/epoch
     training_loss    - pe_loss: 25.499 - force_loss: 264.563 - stress_loss: 5426.328 - total_loss: 832.694
     validation_loss  - pe_loss: 21.732 - force_loss: 222.970 - stress_loss: 4001.949 - total_loss: 644.896

===&gt; Epoch 5/50 - 0.223s/epoch
     training_loss    - pe_loss: 19.913 - force_loss: 256.813 - stress_loss: 4623.454 - total_loss: 739.071
     validation_loss  - pe_loss: 18.560 - force_loss: 204.918 - stress_loss: 3570.819 - total_loss: 580.560

===&gt; Epoch 6/50 - 0.216s/epoch
     training_loss    - pe_loss: 20.351 - force_loss: 214.047 - stress_loss: 4919.543 - total_loss: 726.352
     validation_loss  - pe_loss: 16.724 - force_loss: 187.974 - stress_loss: 2774.870 - total_loss: 482.185

===&gt; Epoch 7/50 - 0.228s/epoch
     training_loss    - pe_loss: 16.538 - force_loss: 212.149 - stress_loss: 4363.531 - total_loss: 665.040
     validation_loss  - pe_loss: 14.973 - force_loss: 169.384 - stress_loss: 2824.495 - total_loss: 466.807

===&gt; Epoch 8/50 - 0.204s/epoch
     training_loss    - pe_loss: 11.135 - force_loss: 173.746 - stress_loss: 3679.028 - total_loss: 552.783
     validation_loss  - pe_loss: 14.269 - force_loss: 155.110 - stress_loss: 2688.537 - total_loss: 438.233

===&gt; Epoch 9/50 - 0.217s/epoch
     training_loss    - pe_loss: 13.449 - force_loss: 152.360 - stress_loss: 3108.144 - total_loss: 476.624
     validation_loss  - pe_loss: 14.968 - force_loss: 141.976 - stress_loss: 3357.161 - total_loss: 492.661

===&gt; Epoch 10/50 - 0.205s/epoch
     training_loss    - pe_loss: 17.161 - force_loss: 144.477 - stress_loss: 3740.302 - total_loss: 535.668
     validation_loss  - pe_loss: 16.087 - force_loss: 129.152 - stress_loss: 3363.140 - total_loss: 481.553

===&gt; Epoch 11/50 - 0.211s/epoch
     training_loss    - pe_loss: 17.185 - force_loss: 121.094 - stress_loss: 3050.336 - total_loss: 443.312
     validation_loss  - pe_loss: 17.087 - force_loss: 113.933 - stress_loss: 2551.663 - total_loss: 386.186

===&gt; Epoch 12/50 - 0.224s/epoch
     training_loss    - pe_loss: 16.637 - force_loss: 109.219 - stress_loss: 2370.110 - total_loss: 362.866
     validation_loss  - pe_loss: 17.689 - force_loss: 97.074 - stress_loss: 2602.237 - total_loss: 374.987

===&gt; Epoch 13/50 - 0.217s/epoch
     training_loss    - pe_loss: 16.613 - force_loss: 105.366 - stress_loss: 2287.128 - total_loss: 350.692
     validation_loss  - pe_loss: 17.418 - force_loss: 91.997 - stress_loss: 2337.202 - total_loss: 343.135

===&gt; Epoch 14/50 - 0.215s/epoch
     training_loss    - pe_loss: 19.297 - force_loss: 87.292 - stress_loss: 1404.290 - total_loss: 247.018
     validation_loss  - pe_loss: 16.794 - force_loss: 88.163 - stress_loss: 2260.646 - total_loss: 331.022

===&gt; Epoch 15/50 - 0.190s/epoch
     training_loss    - pe_loss: 16.452 - force_loss: 93.070 - stress_loss: 1363.711 - total_loss: 245.893
     validation_loss  - pe_loss: 16.137 - force_loss: 82.981 - stress_loss: 2126.521 - total_loss: 311.770

===&gt; Epoch 16/50 - 0.193s/epoch
     training_loss    - pe_loss: 16.693 - force_loss: 79.436 - stress_loss: 1505.886 - total_loss: 246.717
     validation_loss  - pe_loss: 15.632 - force_loss: 78.440 - stress_loss: 1899.606 - total_loss: 284.033

===&gt; Epoch 17/50 - 0.203s/epoch
     training_loss    - pe_loss: 16.359 - force_loss: 84.692 - stress_loss: 1567.637 - total_loss: 257.815
     validation_loss  - pe_loss: 15.098 - force_loss: 72.142 - stress_loss: 1882.750 - total_loss: 275.515

===&gt; Epoch 18/50 - 0.247s/epoch
     training_loss    - pe_loss: 17.538 - force_loss: 70.511 - stress_loss: 1223.243 - total_loss: 210.374
     validation_loss  - pe_loss: 14.630 - force_loss: 67.023 - stress_loss: 2512.499 - total_loss: 332.903

===&gt; Epoch 19/50 - 0.191s/epoch
     training_loss    - pe_loss: 14.991 - force_loss: 68.985 - stress_loss: 1350.129 - total_loss: 218.989
     validation_loss  - pe_loss: 14.003 - force_loss: 63.077 - stress_loss: 2543.449 - total_loss: 331.425

===&gt; Epoch 20/50 - 0.200s/epoch
     training_loss    - pe_loss: 15.257 - force_loss: 59.828 - stress_loss: 1157.593 - total_loss: 190.844
     validation_loss  - pe_loss: 13.590 - force_loss: 59.145 - stress_loss: 2209.569 - total_loss: 293.691

===&gt; Epoch 21/50 - 0.228s/epoch
     training_loss    - pe_loss: 13.402 - force_loss: 67.119 - stress_loss: 1015.503 - total_loss: 182.071
     validation_loss  - pe_loss: 13.357 - force_loss: 53.518 - stress_loss: 1958.299 - total_loss: 262.704

===&gt; Epoch 22/50 - 0.193s/epoch
     training_loss    - pe_loss: 13.518 - force_loss: 56.822 - stress_loss: 839.241 - total_loss: 154.264
     validation_loss  - pe_loss: 13.425 - force_loss: 48.992 - stress_loss: 1616.169 - total_loss: 224.034

===&gt; Epoch 23/50 - 0.253s/epoch
     training_loss    - pe_loss: 13.768 - force_loss: 56.009 - stress_loss: 877.928 - total_loss: 157.570
     validation_loss  - pe_loss: 13.435 - force_loss: 48.059 - stress_loss: 1219.728 - total_loss: 183.467

===&gt; Epoch 24/50 - 0.231s/epoch
     training_loss    - pe_loss: 13.434 - force_loss: 58.265 - stress_loss: 1123.461 - total_loss: 184.045
     validation_loss  - pe_loss: 13.149 - force_loss: 42.599 - stress_loss: 1004.809 - total_loss: 156.228

===&gt; Epoch 25/50 - 0.207s/epoch
     training_loss    - pe_loss: 11.494 - force_loss: 49.842 - stress_loss: 948.868 - total_loss: 156.223
     validation_loss  - pe_loss: 13.072 - force_loss: 36.523 - stress_loss: 985.632 - total_loss: 148.158

===&gt; Epoch 26/50 - 0.217s/epoch
     training_loss    - pe_loss: 13.035 - force_loss: 46.092 - stress_loss: 821.157 - total_loss: 141.243
     validation_loss  - pe_loss: 13.018 - force_loss: 34.420 - stress_loss: 879.450 - total_loss: 135.384

===&gt; Epoch 27/50 - 0.199s/epoch
     training_loss    - pe_loss: 14.402 - force_loss: 39.259 - stress_loss: 422.067 - total_loss: 95.868
     validation_loss  - pe_loss: 12.979 - force_loss: 32.963 - stress_loss: 743.509 - total_loss: 120.293

===&gt; Epoch 28/50 - 0.207s/epoch
     training_loss    - pe_loss: 13.238 - force_loss: 41.517 - stress_loss: 430.548 - total_loss: 97.810
     validation_loss  - pe_loss: 12.728 - force_loss: 29.243 - stress_loss: 581.828 - total_loss: 100.154

===&gt; Epoch 29/50 - 0.205s/epoch
     training_loss    - pe_loss: 12.872 - force_loss: 36.499 - stress_loss: 506.248 - total_loss: 99.996
     validation_loss  - pe_loss: 12.348 - force_loss: 27.912 - stress_loss: 696.936 - total_loss: 109.954

===&gt; Epoch 30/50 - 0.232s/epoch
     training_loss    - pe_loss: 12.664 - force_loss: 44.302 - stress_loss: 485.721 - total_loss: 105.538
     validation_loss  - pe_loss: 12.160 - force_loss: 28.085 - stress_loss: 690.873 - total_loss: 109.333

===&gt; Epoch 31/50 - 0.224s/epoch
     training_loss    - pe_loss: 12.688 - force_loss: 35.669 - stress_loss: 385.926 - total_loss: 86.950
     validation_loss  - pe_loss: 12.399 - force_loss: 26.697 - stress_loss: 563.213 - total_loss: 95.418

===&gt; Epoch 32/50 - 0.210s/epoch
     training_loss    - pe_loss: 12.791 - force_loss: 30.050 - stress_loss: 371.575 - total_loss: 79.998
     validation_loss  - pe_loss: 12.590 - force_loss: 26.551 - stress_loss: 511.294 - total_loss: 90.270

===&gt; Epoch 33/50 - 0.238s/epoch
     training_loss    - pe_loss: 13.013 - force_loss: 33.084 - stress_loss: 518.474 - total_loss: 97.944
     validation_loss  - pe_loss: 12.531 - force_loss: 26.636 - stress_loss: 437.782 - total_loss: 82.945

===&gt; Epoch 34/50 - 0.175s/epoch
     training_loss    - pe_loss: 12.870 - force_loss: 27.200 - stress_loss: 465.778 - total_loss: 86.648
     validation_loss  - pe_loss: 12.371 - force_loss: 26.732 - stress_loss: 472.396 - total_loss: 86.342

===&gt; Epoch 35/50 - 0.230s/epoch
     training_loss    - pe_loss: 13.072 - force_loss: 28.979 - stress_loss: 457.129 - total_loss: 87.764
     validation_loss  - pe_loss: 12.162 - force_loss: 27.584 - stress_loss: 405.666 - total_loss: 80.313

===&gt; Epoch 36/50 - 0.177s/epoch
     training_loss    - pe_loss: 12.871 - force_loss: 28.323 - stress_loss: 359.149 - total_loss: 77.109
     validation_loss  - pe_loss: 11.897 - force_loss: 25.966 - stress_loss: 308.571 - total_loss: 68.720

===&gt; Epoch 37/50 - 0.216s/epoch
     training_loss    - pe_loss: 12.214 - force_loss: 30.554 - stress_loss: 343.573 - total_loss: 77.126
     validation_loss  - pe_loss: 11.583 - force_loss: 27.246 - stress_loss: 341.293 - total_loss: 72.958

===&gt; Epoch 38/50 - 0.205s/epoch
     training_loss    - pe_loss: 11.326 - force_loss: 27.573 - stress_loss: 374.659 - total_loss: 76.365
     validation_loss  - pe_loss: 10.775 - force_loss: 27.324 - stress_loss: 264.535 - total_loss: 64.553

===&gt; Epoch 39/50 - 0.225s/epoch
     training_loss    - pe_loss: 10.716 - force_loss: 25.122 - stress_loss: 391.479 - total_loss: 74.985
     validation_loss  - pe_loss: 9.601 - force_loss: 25.424 - stress_loss: 377.649 - total_loss: 72.790

===&gt; Epoch 40/50 - 0.196s/epoch
     training_loss    - pe_loss: 9.577 - force_loss: 25.639 - stress_loss: 416.391 - total_loss: 76.855
     validation_loss  - pe_loss: 8.494 - force_loss: 26.807 - stress_loss: 416.565 - total_loss: 76.958

===&gt; Epoch 41/50 - 0.198s/epoch
     training_loss    - pe_loss: 8.368 - force_loss: 23.657 - stress_loss: 287.868 - total_loss: 60.812
     validation_loss  - pe_loss: 7.708 - force_loss: 26.754 - stress_loss: 422.066 - total_loss: 76.668

===&gt; Epoch 42/50 - 0.230s/epoch
     training_loss    - pe_loss: 8.452 - force_loss: 24.731 - stress_loss: 315.003 - total_loss: 64.683
     validation_loss  - pe_loss: 7.105 - force_loss: 28.294 - stress_loss: 299.194 - total_loss: 65.318

===&gt; Epoch 43/50 - 0.229s/epoch
     training_loss    - pe_loss: 8.083 - force_loss: 24.970 - stress_loss: 254.668 - total_loss: 58.519
     validation_loss  - pe_loss: 6.269 - force_loss: 28.521 - stress_loss: 253.969 - total_loss: 60.187

===&gt; Epoch 44/50 - 0.183s/epoch
     training_loss    - pe_loss: 6.112 - force_loss: 23.348 - stress_loss: 235.360 - total_loss: 52.995
     validation_loss  - pe_loss: 5.358 - force_loss: 29.082 - stress_loss: 208.927 - total_loss: 55.332

===&gt; Epoch 45/50 - 0.226s/epoch
     training_loss    - pe_loss: 6.441 - force_loss: 26.129 - stress_loss: 156.721 - total_loss: 48.242
     validation_loss  - pe_loss: 4.450 - force_loss: 28.374 - stress_loss: 186.346 - total_loss: 51.459

===&gt; Epoch 46/50 - 0.221s/epoch
     training_loss    - pe_loss: 4.000 - force_loss: 23.461 - stress_loss: 151.348 - total_loss: 42.597
     validation_loss  - pe_loss: 3.738 - force_loss: 27.473 - stress_loss: 168.654 - total_loss: 48.076

===&gt; Epoch 47/50 - 0.185s/epoch
     training_loss    - pe_loss: 4.507 - force_loss: 23.344 - stress_loss: 174.907 - total_loss: 45.341
     validation_loss  - pe_loss: 3.287 - force_loss: 27.115 - stress_loss: 141.923 - total_loss: 44.594

===&gt; Epoch 48/50 - 0.183s/epoch
     training_loss    - pe_loss: 3.173 - force_loss: 24.408 - stress_loss: 139.998 - total_loss: 41.581
     validation_loss  - pe_loss: 2.883 - force_loss: 26.482 - stress_loss: 162.336 - total_loss: 45.598

===&gt; Epoch 49/50 - 0.231s/epoch
     training_loss    - pe_loss: 3.309 - force_loss: 21.386 - stress_loss: 93.648 - total_loss: 34.059
     validation_loss  - pe_loss: 2.527 - force_loss: 24.680 - stress_loss: 203.034 - total_loss: 47.511

===&gt; Epoch 50/50 - 0.209s/epoch
     training_loss    - pe_loss: 2.896 - force_loss: 23.390 - stress_loss: 137.304 - total_loss: 40.017
     validation_loss  - pe_loss: 2.308 - force_loss: 23.773 - stress_loss: 195.185 - total_loss: 45.600

End of training, elapsed time:  00:00:10
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the training loss</span>

<span class="n">model</span><span class="o">.</span><span class="n">plot_loss</span><span class="p">(</span><span class="n">start_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/example_22_0.png" src="_images/example_22_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/example_22_1.png" src="_images/example_22_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/example_22_2.png" src="_images/example_22_2.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/example_22_3.png" src="_images/example_22_3.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Evaluate using the first 5 data in test dataset</span>

<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">return_prediction</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Evaluation loss is:
        pe_loss:       1.5027e+00
     force_loss:       3.3879e+01
    stress_loss:       2.5975e+02
     total_loss:       6.1357e+01
The total loss is computed using the loss weights - pe: 1.00 - force: 1.00 - stress: 0.10
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># prediction using the first 5 data in test dataset</span>

<span class="n">input_dict</span> <span class="o">=</span> <span class="n">get_input_dict</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;pe&#39;: array([-24.43516537, -27.25794917, -26.44558567, -29.71721262,
        -26.18328476]),
 &#39;force&#39;: array([[[-14.98369464,  60.16402837, -11.24057251],
         [ 27.58750673, -46.4019775 ,  11.68806955],
         [ 50.03849536,  47.02174987, -46.65503074],
         [-62.64230727, -60.78380053,  46.2075337 ]],

        [[ 66.39126588,  -0.918724  ,  31.74912699],
         [  2.26208116,  17.5541579 , -31.09016267],
         [-42.02774142,  45.56440882, -12.25110425],
         [-26.62560584, -62.19984267,  11.59213992]],

        [[-70.52058765,  80.59492525, -15.88633072],
         [ 95.63537577, -90.82699739,  12.29866236],
         [ 40.98061171, -82.91953395,  15.95529539],
         [-66.09539983,  93.15160611, -12.36762705]],

        [[ 35.92992587, -28.45139903,  43.08669821],
         [-42.52183304,  13.74105695, -30.8883209 ],
         [ 28.8808097 ,  16.15299698,  12.92609446],
         [-22.28890239,  -1.4426549 , -25.12447177]],

        [[ 10.62635586, -23.71130926,   3.13159382],
         [-24.0703802 ,  40.75223825,   3.90257854],
         [ -6.31185408, -37.11107881,  26.76910415],
         [ 19.75587847,  20.07014987, -33.80327653]]]),
 &#39;stress&#39;: array([[-4.74467792e+02,  4.50541291e+01,  7.48435275e-01,
          4.50541293e+01, -4.45066829e+02, -1.39581531e+00,
          7.48433858e-01, -1.39581685e+00,  8.08017409e-01],
        [ 1.46181081e+03,  3.81848270e+01, -3.52670752e+00,
          3.81848270e+01,  1.34280176e+03,  4.23490518e+00,
         -3.52670589e+00,  4.23490481e+00, -1.47902890e+00],
        [-1.00130692e+03, -1.73574190e+01,  3.24464109e+00,
         -1.73574189e+01, -1.03593198e+03, -3.93371377e+00,
          3.24464110e+00, -3.93371389e+00,  5.60459398e-01],
        [-6.92777205e+02, -3.50395507e+01,  3.72795564e-01,
         -3.50395507e+01, -6.08529653e+02, -4.44634887e-01,
          3.72794506e-01, -4.44634859e-01,  6.23967448e-01],
        [ 9.13840620e+01, -5.63079683e+01, -4.92513182e-01,
         -5.63079682e+01,  4.23616309e+02,  9.50404198e-01,
         -4.92513625e-01,  9.50403883e-01, -5.03840202e-02]])}
</pre></div></div>
</div>
</section>
<section id="Save/load-model">
<h2>Save/load model<a class="headerlink" href="#Save/load-model" title="Permalink to this heading"></a></h2>
<p><strong>save the trained model</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we re-write the descriptor here to empasize that it should be the same one defined above</span>
<span class="n">descriptor</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;acsf&#39;</span><span class="p">,</span>
              <span class="s1">&#39;cutoff&#39;</span><span class="p">:</span> <span class="mf">6.5</span><span class="p">,</span>
              <span class="s1">&#39;etaG2&#39;</span><span class="p">:[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span>
              <span class="s1">&#39;etaG4&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">],</span>
              <span class="s1">&#39;zeta&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.08</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">50.0</span><span class="p">,</span><span class="mf">100.0</span><span class="p">],</span>
              <span class="s1">&#39;lambda&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]}</span>

<span class="n">save_dir</span> <span class="o">=</span> <span class="s1">&#39;example.tfdnn&#39;</span>
<span class="n">network</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">save_dir</span><span class="p">,</span><span class="n">descriptor</span><span class="o">=</span><span class="n">descriptor</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
INFO:tensorflow:Assets written to: example.tfdnn/assets
Network signatures and descriptor are written to example.tfdnn/parameters for LAMMPS simulation.
</pre></div></div>
</div>
<p><strong>Load the trained model for continuous training and prediction</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imported_model</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>

<span class="c1"># Re-train the model</span>
<span class="n">loss_weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pe&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;force&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;stress&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>

<span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;Adam&#39;</span>
<span class="n">loss_fun</span> <span class="o">=</span> <span class="s1">&#39;rmse&#39;</span>
<span class="n">scaling</span> <span class="o">=</span> <span class="s1">&#39;std&#39;</span>

<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> \
            <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> \
            <span class="n">loss_fun</span> <span class="o">=</span> <span class="n">loss_fun</span><span class="p">,</span> \
            <span class="n">batch_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> \
            <span class="n">lr</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> \
            <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> \
            <span class="n">scaling</span><span class="o">=</span><span class="n">scaling</span><span class="p">,</span> \
            <span class="n">loss_weights</span><span class="o">=</span><span class="n">loss_weights</span><span class="p">,</span> \
            <span class="n">compute_all_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> \
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> \
            <span class="n">append_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Network has been inflated! self.built: True
Forces are used for training.
Stresses are used for training.
Scaling factors are computed using training dataset.
Training dataset are standardized.
Validation dataset are standardized.
Training dataset will be shuffled during training.

===&gt; Epoch 1/5 - 0.209s/epoch
     training_loss    - pe_loss: 3.176 - force_loss: 25.337 - stress_loss: 287.488 - total_loss: 57.262
     validation_loss  - pe_loss: 4.905 - force_loss: 25.092 - stress_loss: 710.237 - total_loss: 101.021

===&gt; Epoch 2/5 - 0.182s/epoch
     training_loss    - pe_loss: 4.932 - force_loss: 24.058 - stress_loss: 421.647 - total_loss: 71.155
     validation_loss  - pe_loss: 5.630 - force_loss: 22.020 - stress_loss: 581.018 - total_loss: 85.751

===&gt; Epoch 3/5 - 0.214s/epoch
     training_loss    - pe_loss: 5.663 - force_loss: 20.711 - stress_loss: 462.624 - total_loss: 72.636
     validation_loss  - pe_loss: 7.609 - force_loss: 21.834 - stress_loss: 472.273 - total_loss: 76.671

===&gt; Epoch 4/5 - 0.204s/epoch
     training_loss    - pe_loss: 7.579 - force_loss: 18.940 - stress_loss: 349.679 - total_loss: 61.486
     validation_loss  - pe_loss: 9.569 - force_loss: 19.086 - stress_loss: 308.439 - total_loss: 59.499

===&gt; Epoch 5/5 - 0.196s/epoch
     training_loss    - pe_loss: 8.719 - force_loss: 20.088 - stress_loss: 184.540 - total_loss: 47.261
     validation_loss  - pe_loss: 9.957 - force_loss: 19.737 - stress_loss: 293.991 - total_loss: 59.094

End of training, elapsed time:  00:00:01
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imported_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">return_prediction</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Evaluation loss is:
        pe_loss:       1.5027e+00
     force_loss:       3.3879e+01
    stress_loss:       2.5975e+02
     total_loss:       6.1357e+01
The total loss is computed using the loss weights - pe: 1.00 - force: 1.00 - stress: 0.10
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_dict</span> <span class="o">=</span> <span class="n">get_input_dict</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">imported_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;pe&#39;: array([-24.43516537, -27.25794917, -26.44558567, -29.71721262,
        -26.18328476]),
 &#39;force&#39;: array([[[-14.98369464,  60.16402837, -11.24057251],
         [ 27.58750673, -46.4019775 ,  11.68806955],
         [ 50.03849536,  47.02174987, -46.65503074],
         [-62.64230727, -60.78380053,  46.2075337 ]],

        [[ 66.39126588,  -0.918724  ,  31.74912699],
         [  2.26208116,  17.5541579 , -31.09016267],
         [-42.02774142,  45.56440882, -12.25110425],
         [-26.62560584, -62.19984267,  11.59213992]],

        [[-70.52058765,  80.59492525, -15.88633072],
         [ 95.63537577, -90.82699739,  12.29866236],
         [ 40.98061171, -82.91953395,  15.95529539],
         [-66.09539983,  93.15160611, -12.36762705]],

        [[ 35.92992587, -28.45139903,  43.08669821],
         [-42.52183304,  13.74105695, -30.8883209 ],
         [ 28.8808097 ,  16.15299698,  12.92609446],
         [-22.28890239,  -1.4426549 , -25.12447177]],

        [[ 10.62635586, -23.71130926,   3.13159382],
         [-24.0703802 ,  40.75223825,   3.90257854],
         [ -6.31185408, -37.11107881,  26.76910415],
         [ 19.75587847,  20.07014987, -33.80327653]]]),
 &#39;stress&#39;: array([[-4.74467792e+02,  4.50541291e+01,  7.48435275e-01,
          4.50541293e+01, -4.45066829e+02, -1.39581531e+00,
          7.48433858e-01, -1.39581685e+00,  8.08017409e-01],
        [ 1.46181081e+03,  3.81848270e+01, -3.52670752e+00,
          3.81848270e+01,  1.34280176e+03,  4.23490518e+00,
         -3.52670589e+00,  4.23490481e+00, -1.47902890e+00],
        [-1.00130692e+03, -1.73574190e+01,  3.24464109e+00,
         -1.73574189e+01, -1.03593198e+03, -3.93371377e+00,
          3.24464110e+00, -3.93371389e+00,  5.60459398e-01],
        [-6.92777205e+02, -3.50395507e+01,  3.72795564e-01,
         -3.50395507e+01, -6.08529653e+02, -4.44634887e-01,
          3.72794506e-01, -4.44634859e-01,  6.23967448e-01],
        [ 9.13840620e+01, -5.63079683e+01, -4.92513182e-01,
         -5.63079682e+01,  4.23616309e+02,  9.50404198e-01,
         -4.92513625e-01,  9.50403883e-01, -5.03840202e-02]])}
</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Gao-group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>